#pragma once
#include <wrl.h>
#include <memory>
#include <d3dcommon.h>
#include <DirectXPackedVector.h>
#include "../Common/d3dx12.h"
#include "FrameResource.h"


class RenderTarget;
struct ID3D12RootSignature;
struct ID3D12PipelineState;
class Mesh;

using namespace Microsoft::WRL;

struct SSAOInputData
{
    RenderTarget* Position;
    RenderTarget* Normal;
    Mesh* Quad;
    UploadBuffer<ObjectConstants>* ObjectCB;
};

class SSAO
{
public:
    SSAO() = default;
    ~SSAO() = default;
    SSAO(const SSAO&) = delete;
    SSAO& operator=(const SSAO&) = delete;
    void init(UINT Width, UINT Height, const DirectX::XMFLOAT4X4& Projection);
    void run(const SSAOInputData& InputData);
    
public:
    CD3DX12_GPU_DESCRIPTOR_HANDLE SSAOMap;
    UINT32 KernelSize;
    float Power;
    float Radius;
    float Bias;
private:
    /*DirectX::PackedVector::XMHALF4 mSSAONoise[16];*/
    DirectX::XMFLOAT4 mSSAONoise[16];
    UINT32 mWidth;
    UINT32 mHeight;
    std::unique_ptr<RenderTarget> mSSAOMap;
    std::unique_ptr<RenderTarget> mSSAOBlurMap;
    ComPtr<ID3D12RootSignature> mRootSignature;
    ComPtr<ID3D12RootSignature> mBlurRootSignature;
    ComPtr<ID3D12PipelineState> mPso;
    ComPtr<ID3D12PipelineState> mBlurPso;
    ComPtr<ID3D12Resource> mKernelUploader;
    ComPtr<ID3D12Resource> mKernelBufferGPU;
    ComPtr<ID3D12GraphicsCommandList> mCommandList;
    ComPtr<ID3DBlob> mVShader;
    ComPtr<ID3DBlob> mPShader;
    ComPtr<ID3DBlob> mVBlurShader;
    ComPtr<ID3DBlob> mPBlurShader;
    CD3DX12_GPU_DESCRIPTOR_HANDLE mNoiseHandle;
};

